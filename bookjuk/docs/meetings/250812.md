# 📅 2025-08-12 회고

> **북적북적(BookJuk)** 프로젝트 좋아요 기능 비즈니스 로직 작성, 테스트

## 🧭 오늘 논의한 주요 내용

* 좋아요 기능 구현을 위한 service 코드 작성 및 테스트

## 🚩 내일 작업할 내용

* 좋아요 기능 구현 컨트롤러 작성
* 마이페이지 기능 구현을 위한 dto, service 작업 시작

---

## ✅ review(좋아요) 기능 구현 작업 

**좋아요 남기기(받기)** 비즈니스 로직
1. 미팅 정보 확인
    - 미팅 id로 해당 미팅이 존재하는 지 확인
    - 미팅의 종료 여부를 확인한다.
    - 두 조건을 만족하면 유저 조건을 확인한다.
2.  유저 정보 확인
    - reviewer, reviewee가 미팅에 참여중인지 확인한다.
    - reviewer와 reivewee의 id가 서로 다른지 확인한다.
    - 두 조건을 만족하면 좋아요를 남길수(받을수) 있다.
3. 예외 발생 조건 확인
    - 존재하지 않은 미팅일 때
    - 종료되지 않은 미팅일 때
    - 미팅에 참여하지 않은 유저일 때
    - 리뷰를 남기는 유저와 받는 유저가 동일할 때
    - 중복으로 좋아요를 누르려고 할 때   

**QueryDsl 빌드 그래이들 의존성 주입**
```
// QueryDSL 의존성 추가
    implementation 'com.querydsl:querydsl-jpa:5.0.0:jakarta'
    annotationProcessor 'com.querydsl:querydsl-apt:5.0.0:jakarta'
    annotationProcessor 'jakarta.annotation:jakarta.annotation-api:2.1.1'
    annotationProcessor 'jakarta.persistence:jakarta.persistence-api:3.1.0'
```

**QueryDsl 사용을 위한 설정파일 생성**
```
@Configuration
@RequiredArgsConstructor
public class QueryDslConfig {

    private final EntityManager em;

    @Bean
    public JPAQueryFactory factory() {
        return new JPAQueryFactory(em);
    }

}
```

**repository 3단계 분리**   
QueryDsl 사용을 위해   
기본 Repository 인터페이스 / 커스텀 Repository 인터페이스 / 커스텀 구현 리포지토리 클래스 3개 파일로 분리했다.   


미팅 id로 사용자를 찾기위해 MeetingParticipantRepository 에 커스텀 리포지토리와 메소드를 작성하고   
구현 리포지토리에 아래 내용을 작성했다.
```
    // queryDsl을 사용하기 위한 의존객체
    // QueryDslConfig 파일에서 설정
    private final JPAQueryFactory factory;

    // 미팅 id로 참여자 찾기
    @Override
    public List<User> findMeetingParticipantsByMeetingId(Long id) {
        return factory
                .select(meetingParticipant.participant)
                .from(meetingParticipant)
                .where(meetingParticipant.meeting.id.eq(id))
                .fetch();
    }
```
미팅 id를 검색하여 참여자 정보를 리스트로 반환, 반환된 리스트는 service 단에서    
reviewerId, revieweeId 와 userId를 비교하여 참여자인지 확인한다.   


리뷰 중복을 방지하기 위해 MeetingReviewRepository에 커스텀 리포지토리와 메소드를 작성하고   
구현 리포지토리에 아래 내용을 작성했다.
```
@RequiredArgsConstructor
public class MeetingReviewRepositoryImpl implements MeetingReviewCustomRepository {

    // queryDsl을 사용하기 위한 의존객체
    private final JPAQueryFactory factory;

    @Override
    public boolean existDuplicateReview(Meeting meeting, User reviewer, User reviewee) {
        return factory
                .selectFrom(meetingReview)
                .where(meetingReview.meeting.eq(meeting)
                        .and(meetingReview.reviewer.eq(reviewer))
                        .and(meetingReview.reviewee.eq(reviewee))
                )
                .fetchOne() != null ? true : false;

    }
}
```
같은 미팅에서 리뷰어와 리뷰이에게 좋아요를 누르면 정보가 미팅리뷰 테이블에 저장된다.   
다시 동일한 미팅에서 좋아요를 중복으로 누르는 것을 방지하기 위해 이미 존재한 리뷰가 있는지 확인하고   
존재하는 리뷰가 있다면 true를 반환하고 없으면 false를 반환한다.   
반환되는 값이 true (이미 리뷰가 존재) 면 예외처리를 진행한다.   

**리뷰 관련 예외 추가**   
다른 팀원분이 만들어 두신 커스텀 예외 에러 코드 이넘파일에 에러 코드를 추가했다.
```
// =========================
    // ❤️ 좋아요 / 후기 관련
    // =========================
    MEETING_NOT_COMPLETED("MEETING_NOT_COMPLETED", "미팅이 완료되지 않았습니다.", 400),
    DUPLICATE_LIKE("DUPLICATE_LIKE", "좋아요는 최대 한 번만 누를 수 있습니다.", 400),
    LIKE_SELF_NOT_ALLOWED("LIKE_SELF_NOT_ALLOWED", "자기 자신을 좋아요할 수 없습니다.", 400),
    USER_NOT_PARTICIPANT("USER_NOT_PARTICIPANT", "해당 사용자는 모임 참여자가 아닙니다.", 400),
```

---

## ✅ review(좋아요) 기능 테스트
인텔리제이에서 제공하는 테스트 도구 Junit을 활용하여 TDD(given-when-then) 스타일로 MeetingRepository,   MeetingParticipantRepository, MeetingReviewRepository, MeetingReviewService를 JPA를 이용하여 간단한 CRUD 테스트를 진행   
더미 유저, 더미 미팅, 더미 미팅 참여 정보는 미팅 참여 테스트 시 팀원분이 작성하신 코드를 활용하여 테스트를 진행했다. 
```
 // ========== MeetingReviewRepository: CREATE ==========
    @Test
    @DisplayName("모임이 종료된 후 다른 사용자에게 리뷰(좋아요)를 남긴다")
    void createReview() {
        // given
        Long meetingId =  m1.getId();
        Long reviewerId = u2.getId();
        Long revieweeId = u3.getId();

        // when
        ReviewResponse response = reviewService.createReview(meetingId, reviewerId, revieweeId);

        // then
        System.out.println("response = " + response);
    }
```
---

## 💭 8/12 일 회고
좋아요 기능의 주요 기능을 완성했다. 북적북적 독서 모임 서비스 플로우와 기능 명세서를 개발 전에 상세히 작성하니   
필요한 기능이 무엇인지 빠른 판단이 가능했고 큰 문제 없이 좋아요 기능을 구현할 수 있었다.   
트러블슈팅이라고 할 정도의 문제는 발생하지 않았으나 테스트 시 db 칼럼명과 더미로 구현한 유저 엔티티간의 필드명이   
상이하여 테스트 시 SQLexception이 떴다.   
테스트 시 유저 엔티티는 아직 구현 전이라 테스트용으로 작성했다는 다른 팀원분의 답을 듣고 좋아요 기능 테스트에 필요한  
내용으로 수정하여 테스트를 완료했다.   

아래의 내용은 MeetingReview 엔티티와 작성하면서 다시 복습하게 된 내용이다.   
- mappedBy 값은 연관 대상 엔티티의 필드 이름(객체 필드명) 을 가리켜야 한다.
- JPA가 @JoinColumn으로 연결된 필드에서 자동으로 외래키(id)를 다루기 때문에 연관관계에서는 객체로 연관관계를 맺는다.

