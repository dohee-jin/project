# 📅 2025-08-14 회고

> **북적북적(BookJuk)** 프로젝트 마이페이지 정보 조회 api controller 작성 및 api 포스트맨 테스트

## 🧭 오늘 논의한 주요 내용

* 마이페이지 정보 조회 api controller 작성

## 🚩 내일 작업할 내용

* 좋아요 기능 구현 컨트롤러 작성
* 마이페이지 기능 구현을 위한 dto, service 작업 시작

---

## ✅ 마이페이지 정보 응답 DTO 생성
마이페이지는 유저정보, 유저가 참여한(호스트, 참여자) 모임 정보, 통계 정보(참여 모임 수, 받은 좋아요 수)를 한번에 응답 받아야 하여 UserInfoDto, MeetingDto, StaticsInfoDto 3개와, 3개의 dto를 감쌀 MyPageResponse Dto를 생성했다. 
```
MyPageResponse dto
public class MyPageResponse {


    private UserInfoDto profile;
    private StaticsInfoDto statistics;
    private List<MeetingInfoDto> meetings;


    // 마이페이지 응답 dto로 바꾸는 정적 팩토리 메소드
    public static MyPageResponse of(UserInfoDto profile, StaticsInfoDto statistics, List<MeetingInfoDto> meetings) {

        return MyPageResponse.builder()
                .profile(profile)
                .statistics(statistics)
                .meetings(meetings)
                .build();
    }
}

UserInfoDto dto
public class UserInfoDto {

    // 유저 정보
    private String username;
    private String email;
    private String profileImage;
    private String preferredGenre;
    private String introduction;

    // 유저 객체를 MyPage 최상위 응답 dto로 보내기 위한 중간 정적 팩토리 메소드
    public static UserInfoDto from(User user) {
        return UserInfoDto.builder()
                .username(user.getUsername())
                .email(user.getEmail())
                .profileImage(user.getProfileImage())
                .preferredGenre(user.getPreferredGenre())
                .introduction(user.getIntroduction())
                .build();
    }
}

MeetingInfoDto dto
public class MeetingInfoDto {

    // 모임 정보
    private Long meetingId;
    private String meetingTitle;
    private LocalDateTime meetingTime;
    private MeetingStatus meetingStatus;
    private ParticipantRole role;
    private Map<String, String> book;

    public static MeetingInfoDto from(MeetingParticipant meetingParticipant) {
        Meeting meeting = meetingParticipant.getMeeting();

        Map<String, String> bookMap = new HashMap<>();
        bookMap.put("title", meeting.getBookTitle());
        bookMap.put("author", meeting.getBookAuthor());

        return MeetingInfoDto.builder()
                .meetingId(meeting.getId())
                .meetingTitle(meeting.getTitle())
                .meetingTime(meeting.getMeetingTime())
                .meetingStatus(meeting.getMeetingStatus())
                .role(meetingParticipant.getRole())
                .book(bookMap)
                .build();

    }
}

StaticsInfoDto dto
public class StaticsInfoDto {

    private Long receivedLikes;
    private int participatedMeeting;

    public static StaticsInfoDto of(Long likes, int meetings) {
        return StaticsInfoDto.builder()
                .receivedLikes(likes)
                .participatedMeeting(meetings)
                .build();
    }

}
```

## ✅ 마이페이지 service 비즈니스 로직 작성

마이페이지는 여러 정보를 한 번에 가져오고 있어 각각의 정보를 조회해오는 메소드를 만들고    
큰 메소드를 하나 만들어 컨트롤러에서 큰 메소드만 불러와도 유저, 참여 모임, 통계 정보를 다 받을 수 있게 만들었다.
```
public class MyPageService {

    // 의존 객체 주입
    private final UserRepository userRepository;
    private final MeetingRepository meetingRepository;
    private final MeetingReviewRepository meetingReviewRepository;
    private final MeetingParticipantRepository meetingParticipantRepository;
    private final LocalFileService localFileService;

    /**
     * 마이페이지 진입 정보 조회(디폴트) 로직입니다.
     * @param email - 로그인한 유저가 제시한 토큰에서 파싱한 이메일 정보
     * @return - 프론트 단에 전달할 유저 정보, 유저 모임 정보, 유저의 모임 참여, 좋아요 통계 정보를 반환합니다.
     */
    public MyPageResponse getMyPage(String email) {

        // 1. 사용자 이메일로 유저 정보 가져오기
        User user = getUserByEmail(email);

        // 조회된 유저 정보를 마이페이지 응답에 필요한 dto 로 변경
        UserInfoDto profile = UserInfoDto.from(user);

        // 2. 유저가 참여한 모임 정보 가져오기
        // meeting_participant 에 유저 id로 참여 모임 id를 리스트로 반환
        Long userId = user.getId();
        List<MeetingInfoDto> meetings = getMeetingsByUserId(userId);

        // 3. 유저의 모임 참여, 좋아요 통계 정보를 가져오기
        int meetingCount = meetings.size();
        StaticsInfoDto stats = getStatsByUserId(userId, meetingCount);

        return MyPageResponse.of(profile, stats, meetings);

    }

    /**
     * 사용자의 email 정보로 user 객체를 가져올 때 사용하는 메소드입니다.
     * @param email - 로그인한 유저가 제시한 토큰에서 파싱한 이메일 정보
     * @return User - 일치하는 사용자 정보가 있으면 해당 User 객체를 반환, 없으면 커스텀 에러를 반환
     */
    private User getUserByEmail(String email) {
        return userRepository.findByEmail(email).orElseThrow(
                () -> new CustomException(ErrorCode.USER_NOT_FOUND)
        );
    }

    /**
     * 사용자의 id 정보로 참여한 미팅 정보를 가져오고 필요한 정보만 반환하는 메소드입니다.
     * @param id - 이메일 정보로 찾은 유저의 id
     * @return - 유저의 id 로 참여한 미팅 정보를 리스트로 받은 후 필요한 정보만 dto 로 매핑한 리스트
     */
    private List<MeetingInfoDto> getMeetingsByUserId(Long id) {
        // 사용자 id 정보로 참여한 미팅 정보 반환
        List<MeetingParticipant> meetingParticipants =
                meetingParticipantRepository.findMeetingsByUserId(id);

        // 반환된 리스트를 for 돌려서 dto 로 매핑
        return meetingParticipants
                .stream()
                .map(meeting -> MeetingInfoDto.from(meeting))
                .collect(Collectors.toList());

    }

    /**
     * 사용자의 id 정보로 받은 좋아요 개수를 조회하고 참여한 리스트 개수와 함께 필요한 정보만 반환하는 메소드입니다.
     * @param id - 이메일 정보로 찾은 유저 id
     * @param count - 참여 리스트의 size
     * @return - 유저 id 정보롤 찾은 좋아요 개수와 참여 리스트의 개수를 받아 필요한 정보만 매핑한 dto
     */
    private StaticsInfoDto getStatsByUserId(Long id, int count) {
        Long reviewCount = meetingReviewRepository.countReviewByUserId(id);
        return StaticsInfoDto.of(reviewCount, count);
    }

}
```

---

## 💭 8/13 일 회고
마이페이지에서 받아야 할 정보가 많아 처음에 구조와 처리 방법을 고민했다.   
미팅 테이블에서 책 정보를 받아올 때 API 명세서에는 객체 형태였지만 책 정보를 담고 있는 엔터티가 없기 때문에 맵 타입으로 처리했다.   
책 정보는 DTO 내에 선언한 큰 맵안에 책 정보를 가지고 있는 맵을 넣어 에러 없이 구현할 수 있었다.   
선호 장르의 경우 보통 다른 서비스에서는 여러개를 선택할 수 있지만 현재 개발 기간 내에 구현하기는 조금 복잡할 것 같아서 한 개만 설정 가능하도록 하게 하고 문자열로 처리했다.

**향후 개선점**
- 책 관련 기능을 확장하면서 Book 객체를 생성해 관리하면 기능 구현과 유지보수가 더 깔끔해질 것 같다.   
- 선호 장르를 별도의 테이블로 관리하면 개인화 기능 확장에 유리할 것 같다.