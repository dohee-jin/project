# 📅 2025-09-17

> **트로피칼** 프로젝트

## 🧭 오늘 작업한 주요 내용

* AI 스몰토크 주제 생성 기능 개발 (BE)
    * spring ai 사용 설정
    * 프론트엔드 응답 DTO 생성
    * AI <-> 백엔드 요청 dto, 응답 dto 생성

## 🚩 내일 작업할 내용

* AI 스몰토크 주제 생성 기능 개발 (BE)
    * AI 스몰토크 주제 생성 비즈니스 로직 작성

---

## ✅ AI 스몰토크 주제 생성 기능 개발 (BE)

* **Spring ai 사용 설정**
    * build.gradle 설정   
    Spring AI 사용을 위해 build.gradle에 의존성 설정을 추가했다.   
    ```
    ext {
        set('springAiVersion', '1.0.0-M5')
    }
    repositories {
        // 중앙 저장소 사용(회사 Nexus/Artifactory 없을 때 기본)
        mavenCentral()
        maven { url 'https://repo.spring.io/milestone' }
    }
    dependencies {
        implementation "org.springframework.ai:spring-ai-openai-spring-boot-starter:${springAiVersion}" 
    }
    ```

    * application.yml 설정
    ```
    spring: 
        ai:
            openai:
            base-url: https://generativelanguage.googleapis.com/v1beta/openai/
            api-key: ${GEMINI_API_KEY}
            chat:
                completions-path: /chat/completions
                options:
                model: ${GEMINI_MODEL}
                temperature: 0.2
                max-tokens: 1024
            retry:
            on-client-errors: true
            on-http-codes: 429,503
            initial-interval: 500ms
            max-attempts: 3
    ```

    * .env 파일에 AI key, model 값 추가

* **프론트엔드 응답 DTO 생성**   
    db에 저장된 스몰토크 주제를 프론트엔드로 뿌리기 위한 프론트엔드용 응답 dto 생성   
    레코드를 사용하여 dto를 만들었다.
    ``` SmallTalkTopicDto
    public record SmallTalkTopicDto(
            Long id,
            String topicType,
            String topicContent,
            String exampleQuestion,
            List<SmalltalkSourcesDto> sources
    ) {

        public static SmallTalkTopicDto from(SmalltalkTopic topic,
                                            List<SmalltalkSourcesDto> sources) {
            return new SmallTalkTopicDto(
                    topic.getId(),
                    topic.getTopicType(),
                    topic.getTopicContent(),
                    topic.getExampleQuestion(),
                    sources
            );
        }
    }
    ```
    ```SmallTalkSourceDto
    public record SmalltalkSourcesDto(
        Long sourceId,
        String sourceType
    ) {
        public static SmalltalkSourcesDto from(SmalltalkSources sources) {
            return new SmalltalkSourcesDto(
                    sources.getSourceId(),
                    sources.getSourceType().name()
            );
        }
    }
    ```

* **AI <-> 백엔드 요청/응답 DTO 생성**   
    AI 요청/응답을 dto로 통일하여 명확한 데이터 흐름을 만들었다.      

    AI 요청 dto 는 사용자의 활동 기록 하나를 담을 ActivityDto와 ActivityDto를 묶어 AI에게 전달하는 TopicGenerateRequest Dto 로 구성했다.
    ```ActivityDto
    public record ActivityDto(
            Long id,
            String title,
            String content,
            LocalDateTime createdAt
    ) {
    }
    ``` 
    ```TopicGenerateRequest
    public record TopicGenerateRequest (
        int topicCount,
        Map<SourceType, List<ActivityDto>> activities //
    ) {
    }
    ```   

    AI 응답 dto는 db 구조에 맞게 Source 정보를 받을 dto와 Source 정보를 포함한 전체 dto로 구성했다.
    ```AISourceDto
    public record AISourceDto(
            Long sourceId,
            SourceType sourceType
    ) {
    }
    ```
    ```AISmallTalkResponse
    public record AISmallTalkResponse(
        String topicType,
        String topicContent,
        String exampleQuestion,
        List<Double> embedding,
        List<AISourceDto> sources

    ) {
    }
    ```
---

## 💭 9/17 일 회고   
DB 구조를 기반으로 AI 주제 생성 로직에 필요한 요청/응답 DTO를 먼저 작성했다. 레코드를 활용해 기존 클래스 방식보다 코드가 간결해지고 불필요한 보일러플레이트가 줄어드는 것을 체감할 수 있었다. AI와의 연결은 기존 RestTemplate, WebClient 대신 Spring AI를 채택하여 최신 기술을 경험하며 개발할 계획이다. 이번 경험을 통해 설계 단계에서 DTO 구조를 잘 잡는 것이 후속 구현의 효율성을 크게 높인다는 점을 배웠다.